# ijkplayer 音视频同步机制分析

## 1. 同步基本概念

在音视频播放过程中，由于音频和视频的解码、渲染速度不同，可能会出现音视频不同步的情况。为了解决这个问题，ijkplayer采用了基于时钟的同步机制，通过一个主时钟来控制音频和视频的播放节奏，使它们能够协调一致地播放。

## 2. 同步类型

ijkplayer支持三种同步类型，通过`av_sync_type`字段来控制：

1. **AV_SYNC_AUDIO_MASTER** (默认)：以音频时钟为主时钟
2. **AV_SYNC_VIDEO_MASTER**：以视频时钟为主时钟
3. **AV_SYNC_EXTERNAL_CLOCK**：以外部时钟为主时钟

选择主时钟的逻辑在`get_master_sync_type`函数中实现。如果指定了视频主时钟但没有视频流，则会回退到音频主时钟；如果指定了音频主时钟但没有音频流，则会回退到外部时钟。

## 3. 时钟系统

ijkplayer维护了三个时钟：

1. **vidclk**：视频时钟
2. **audclk**：音频时钟
3. **extclk**：外部时钟

时钟结构体`Clock`包含以下关键字段：
- `pts`：时钟基准时间戳
- `pts_drift`：时钟基准与更新时间的差值
- `last_updated`：上次更新时间
- `speed`：时钟速度
- `serial`：时钟基于的数据包序列号

时钟相关的主要函数：
- `get_clock`：获取当前时钟时间
- `set_clock`：设置时钟时间
- `sync_clock_to_slave`：将从时钟同步到主时钟

## 4. 视频同步流程

视频同步的核心在`video_refresh`函数中实现，主要步骤如下：

1. **获取主时钟**：通过`get_master_clock`获取当前的主时钟时间。
2. **计算延迟**：在`compute_target_delay`函数中计算视频帧的显示延迟。
   - 如果主时钟不是视频时钟，则计算视频时钟与主时钟的差值(diff)
   - 根据差值和同步阈值调整延迟时间
     - 如果diff小于负的同步阈值，则加快播放（减少延迟）
     - 如果diff大于正的同步阈值且延迟大于帧重复阈值，则放慢播放（增加延迟）
     - 如果diff大于正的同步阈值，则重复播放当前帧
3. **帧率控制**：根据计算出的延迟时间控制视频帧的显示节奏。
4. **帧丢弃**：如果启用了帧丢弃（framedrop）并且不是以视频为主时钟，当视频帧处理过慢时会丢弃部分视频帧以保持同步。

## 5. 音频同步流程

音频同步的核心在`audio_decode_frame`函数中实现，主要步骤如下：

1. **获取主时钟**：通过`get_master_clock`获取当前的主时钟时间。
2. **计算样本数**：在`synchronize_audio`函数中计算需要输出的音频样本数。
   - 如果主时钟不是音频时钟，则计算音频时钟与主时钟的差值(diff)
   - 根据差值计算需要调整的样本数
   - 通过重采样器（swr_convert）调整输出样本数
3. **重采样**：如果需要调整播放速度，会使用swr_convert进行重采样。

## 6. 关键参数

- **AV_SYNC_THRESHOLD_MIN**：最小同步阈值（0.04秒）
- **AV_SYNC_THRESHOLD_MAX**：最大同步阈值（0.1秒）
- **AV_SYNC_FRAMEDUP_THRESHOLD**：帧重复阈值（0.15秒）
- **AV_NOSYNC_THRESHOLD**：不同步阈值（100.0秒）
- **SAMPLE_CORRECTION_PERCENT_MAX**：最大音频速度调整百分比（10%）

## 7. 同步策略

1. **默认策略**：以音频为主时钟，视频去同步音频。这是因为人耳对音频的敏感度高于人眼对视频的敏感度。
2. **无音频流**：如果视频没有音频流，则会回退到以视频为主时钟或外部时钟。
3. **实时流**：对于实时流（如直播），会根据缓冲区状态调整外部时钟的速度。

## 8. 特殊处理

1. **帧丢弃**：当视频解码或渲染过慢时，会丢弃部分视频帧以保持同步。
2. **音频样本调整**：通过重采样器动态调整音频样本数来实现音频同步。
3. **暂停/恢复**：在暂停和恢复播放时会相应地暂停和恢复所有时钟。

通过这套机制，ijkplayer能够有效地处理各种场景下的音视频同步问题，为用户提供流畅的播放体验。